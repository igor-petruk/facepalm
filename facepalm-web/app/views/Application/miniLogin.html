#{extends 'main.html' /}
#{set title:'Home' /}

<h2>This is mini login to facebook</h2>
<div id="fb_login"> <fb:login-button onlogin="facebookLogin();"></fb:login-button> </div>

<script type="text/javascript">
   			 function facebookLogin() {      		  
       			 FB.getLoginStatus(function(response) {       				
           			 if (response.status === 'connected') {
           				 console.log("resp status=connected");
             		    // the user is logged in and connected to your app
                        addCounter(encodeURIComponent("${siteUrl}"),encodeURIComponent("${imageUrl}"));

         		   } else {
                	   window.location = "@{Application.facebookLogout()}";
            		}
         	     });
    	     }

                var addCounter = function(sUrl,iUrl) {
                    var userAction = #{jsAction @Application.like(':siteUrl',":imageUrl") /}

                    var url = userAction({siteUrl: sUrl,imageUrl:iUrl});
                    $.ajax({
                        url: url,
                        type: 'POST',
                        dataType: "json",
                        success: function(data, status) {
                            window.close();
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            if (jqXHR.status==403){
                                window.close();
                            }
                        }
                    });

                }
</script>

